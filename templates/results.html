{% extends "base.html" %}

{% block title %}{{ campaign.name }} - Sonuçlar{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 1.5rem;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
    }

    .stat-icon {
        font-size: 2.5rem;
        line-height: 1;
        margin-bottom: 1rem;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #111827;
        line-height: 1.2;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    /* File List */
    .file-list-item {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease;
    }

    .file-list-item:hover {
        border-color: #64748b; /* gray-500 as equivalent for var(--primary) if not defined, or use a specific color */
        background: #f8fafc;
    }

    .file-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-right: 1rem;
    }

    .icon-csv { background: #e0f2fe; color: #0369a1; }
    .icon-xlsx { background: #dcfce7; color: #15803d; }

    /* Progress Bar Modern */
    .progress {
        height: 8px;
        border-radius: 999px;
        background-color: #e5e7eb;
        overflow: hidden;
    }
    
    .progress-bar {
        background: linear-gradient(90deg, #475569 0%, #1e293b 100%); /* gray-600 to gray-800 */
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
    <div>
        <div class="flex items-center gap-4 mb-2">
            <h1 class="text-3xl font-bold text-gray-900 tracking-tight">{{ campaign.name }}</h1>
            {% if campaign.status == 'completed' %}
                <span class="px-3 py-1 rounded-full text-sm font-semibold bg-emerald-100 text-emerald-700 border border-emerald-200">Tamamlandı</span>
            {% else %}
                <span class="px-3 py-1 rounded-full text-sm font-semibold bg-amber-100 text-amber-700 border border-amber-200">{{ campaign.status }}</span>
            {% endif %}
        </div>
        <div class="flex items-center text-gray-500 font-medium text-sm">
            <i class="bi bi-calendar4-week mr-2 text-primary-500"></i>
            <span>{{ campaign.start_date }} — {{ campaign.end_date }}</span>
        </div>
    </div>
    <a href="/" class="inline-flex items-center justify-center px-4 py-2 bg-white border border-gray-200 rounded-xl text-gray-600 hover:text-gray-900 hover:border-gray-300 hover:shadow-sm transition-all">
        <i class="bi bi-arrow-left mr-2"></i>Listeye Dön
    </a>
</div>

<!-- Loading State -->
<div id="loadingState" class="py-20 text-center">
    <div class="relative w-24 h-24 mx-auto mb-8">
        <div class="absolute inset-0 border-4 border-gray-100 rounded-full"></div>
        <div class="absolute inset-0 border-4 border-gray-800 rounded-full border-t-transparent animate-spin"></div>
        <i class="bi bi-cpu text-3xl text-gray-800 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></i>
    </div>
    
    <h3 class="text-2xl font-bold text-gray-900 mb-2">Analiz Sonuçları Yükleniyor...</h3>
    <p class="text-gray-500 mb-8 max-w-md mx-auto">Veriler işleniyor ve rapor dosyaları hazırlanıyor. Bu işlem veri boyutuna göre birkaç dakika sürebilir.</p>
    
    <div class="w-full max-w-md mx-auto bg-gray-100 rounded-full h-2.5 overflow-hidden">
        <div class="bg-gray-800 h-2.5 rounded-full animate-progress w-full origin-left-right"></div>
    </div>
    <style>
        @keyframes progress { 0% { width: 0%; } 50% { width: 70%; } 100% { width: 100%; } }
        .animate-progress { animation: progress 2s ease-in-out infinite; }
    </style>
</div>

<!-- Results State -->
<div id="resultsState" style="display:none;">
    
    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10" id="statsCards">
        <!-- JavaScript ile doldurulacak -->
    </div>

    <!-- Quality Control Report -->
    <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6 mb-10">
        <h5 class="font-bold text-gray-900 mb-6 flex items-center">
            <div class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center mr-3">
                <i class="bi bi-shield-check"></i>
            </div>
            Kalite Kontrol Raporu
        </h5>
        <div id="validationReport"></div>
    </div>

    <!-- Files Section -->
    <h5 class="font-bold text-gray-900 mb-6 flex items-center text-lg">
        <div class="w-8 h-8 rounded-lg bg-sky-50 text-sky-600 flex items-center justify-center mr-3">
            <i class="bi bi-cloud-download"></i>
        </div>
        İndirilebilir Dosyalar
    </h5>
    
    <div id="filesList">
        <!-- JavaScript ile doldurulacak -->
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
const campaignId = "{{ campaign.id }}";

// Helper: Format file size
function formatSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Load Results
function loadResults() {
    fetch(`/api/campaign/${campaignId}/files`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'completed') {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('resultsState').style.display = 'block';
            
            renderFiles(data.files);
            
            // Validation varsa göster
            if(data.validation) {
                renderValidation(data.validation);
            }
            
            // Stats varsa göster (backend'den gelmeli, yoksa dosyadan türetiriz)
            if(data.stats) {
                renderStats(data.stats);
            }
        } else if (data.status === 'error') {
            Swal.fire('Hata', 'Analiz sırasında bir hata oluştu.', 'error');
        } else {
            // Hala işleniyor
            setTimeout(loadResults, 2000);
        }
    })
    .catch(error => console.error('Error:', error));
}

function renderFiles(files) {
    const container = document.getElementById('filesList');
    container.innerHTML = '';
    
    if (!files || files.length === 0) {
        container.innerHTML = '<div class="p-4 bg-yellow-50 text-yellow-700 rounded-xl border border-yellow-100">Dosya bulunamadı.</div>';
        return;
    }

    files.forEach(file => {
        const isExcel = file.filename.endsWith('.xlsx');
        const iconClass = isExcel ? 'bg-emerald-100 text-emerald-700' : 'bg-sky-100 text-sky-700';
        const badgeText = isExcel ? 'Excel Raporu' : 'Veri Dosyası';
        const badgeClass = isExcel ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-sky-50 text-sky-700 border-sky-100';

        const html = `
        <div class="file-list-item flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div class="flex items-center w-full sm:w-auto">
                <div class="file-icon ${iconClass.includes('emerald') ? 'icon-xlsx' : 'icon-csv'}">
                    <i class="bi ${isExcel ? 'bi-file-earmark-excel' : 'bi-file-earmark-text'}"></i>
                </div>
                <div>
                    <h6 class="font-bold text-gray-900 mb-1">${file.filename}</h6>
                    <div class="flex items-center text-gray-500 text-sm">
                        <span class="px-2 py-0.5 rounded border ${badgeClass} text-xs mr-2">${badgeText}</span>
                        <span>${formatSize(file.size)}</span>
                        <span class="mx-2">•</span>
                        <span>${new Date(file.created).toLocaleString()}</span>
                    </div>
                </div>
            </div>
            <div class="flex w-full sm:w-auto gap-2">
                <button class="flex-1 sm:flex-none px-3 py-1.5 bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-lg text-sm font-medium transition-colors" onclick="previewFile('${file.filename}')">
                    <i class="bi bi-eye mr-1"></i>Önizle
                </button>
                <a href="/api/campaign/${campaignId}/download/${file.filename}" class="flex-1 sm:flex-none px-3 py-1.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm font-medium transition-colors shadow-sm flex items-center justify-center">
                    <i class="bi bi-download mr-1"></i>İndir
                </a>
            </div>
        </div>
        `;
        container.innerHTML += html;
    });
}

function renderValidation(report) {
    const container = document.getElementById('validationReport');
    let bgClass = 'bg-emerald-50 border-emerald-100';
    let textClass = 'text-emerald-800';
    let icon = 'bi-check-circle-fill text-emerald-500';
    let messages = ['Tüm kontroller başarıyla tamamlandı.'];
    
    if (report.status === 'warning') { 
        bgClass = 'bg-amber-50 border-amber-100'; 
        textClass = 'text-amber-800'; 
        icon = 'bi-exclamation-triangle-fill text-amber-500'; 
        messages = report.warnings || [];
    }
    if (report.status === 'failed' || report.status === 'error') { 
        bgClass = 'bg-rose-50 border-rose-100'; 
        textClass = 'text-rose-800'; 
        icon = 'bi-x-circle-fill text-rose-500'; 
        messages = report.errors || [];
    }

    let html = `
    <div class="rounded-xl border ${bgClass} p-5 flex items-start gap-4">
        <i class="bi ${icon} text-xl mt-0.5"></i>
        <div>
            <h6 class="font-bold ${textClass} mb-2">Durum: ${report.status.toUpperCase()}</h6>
            <ul class="space-y-1 text-sm ${textClass} opacity-90 list-disc list-inside">
                ${messages.map(msg => `<li>${msg}</li>`).join('')}
            </ul>
        </div>
    </div>
    `;
    container.innerHTML = html;
}

function renderStats(stats) {
    const container = document.getElementById('statsCards');
    if (!stats) return;

    // Helper to create card HTML
    const createCard = (title, value, subtext, colorClass, iconClass) => `
        <div class="col-span-1 bg-white rounded-2xl border border-gray-100 p-6 shadow-sm hover:shadow-md transition-all duration-200">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">${title}</p>
                    <h3 class="text-2xl font-bold text-gray-900">${value}</h3>
                </div>
                <div class="w-10 h-10 rounded-xl ${colorClass} flex items-center justify-center text-lg">
                    <i class="bi ${iconClass}"></i>
                </div>
            </div>
            ${subtext ? `<p class="text-xs text-gray-400 font-medium">${subtext}</p>` : ''}
        </div>
    `;

    let cardsHtml = '';
    
    // Total Processed
    if (stats.total_emails !== undefined) {
        cardsHtml += createCard('Toplam İşlenen', stats.total_emails, 'Analiz edilen toplam e-posta', 'bg-blue-50 text-blue-600', 'bi-envelope');
    }
    
    // Success Rate (if available)
    if (stats.match_rate !== undefined) {
        cardsHtml += createCard('Eşleşme Oranı', `%${stats.match_rate}`, 'Başarılı eşleşme yüzdesi', 'bg-emerald-50 text-emerald-600', 'bi-graph-up-arrow');
    }

    // Other stats
    Object.entries(stats).forEach(([key, value]) => {
        if (key !== 'total_emails' && key !== 'match_rate' && typeof value !== 'object') {
            const formattedKey = key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            cardsHtml += createCard(formattedKey, value, '', 'bg-gray-50 text-gray-600', 'bi-bar-chart');
        }
    });

    container.innerHTML = cardsHtml;
}

// Dosya Önizleme Modalı
function previewFile(filename) {
    if (filename.endsWith('.xlsx')) {
        Swal.fire('Bilgi', 'Excel dosyaları önizlenemez, lütfen indirin.', 'info');
        return;
    }
    
    Swal.fire({
        title: 'Yükleniyor...',
        didOpen: () => Swal.showLoading()
    });

    fetch(`/api/campaign/${campaignId}/preview/${filename}`)
        .then(r => r.json())
        .then(data => {
            if(data.error) throw new Error(data.error);
            
            // Tablo oluştur
            let tableHtml = `
            <div class="overflow-x-auto max-h-[400px] border border-gray-200 rounded-lg">
                <table class="min-w-full text-left text-sm whitespace-nowrap">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            ${data.columns.map(col => `<th class="px-4 py-3 font-semibold text-gray-900 border-b border-gray-200">${col}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 bg-white">
                        ${data.data.map(row => `
                            <tr class="hover:bg-gray-50 transition-colors">
                                ${data.columns.map(col => `<td class="px-4 py-2.5 text-gray-600 border-b border-gray-50">${row[col] === null ? '' : row[col]}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;

            Swal.fire({
                title: filename,
                html: tableHtml,
                width: '90%',
                showCloseButton: true,
                confirmButtonText: 'Kapat'
            });
        })
        .catch(err => Swal.fire('Hata', err.message, 'error'));
}

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', loadResults);
</script>
{% endblock %}