{% extends "base.html" %}

{% block title %}{{ campaign.name }} - Sonuçlar{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
    <div>
        <div class="flex items-center gap-4 mb-2">
            <h1 class="text-3xl font-bold text-gray-900 tracking-tight">{{ campaign.name }}</h1>
            {% if campaign.status == 'completed' %}
                <span class="px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700 border border-green-200">Tamamlandı</span>
            {% else %}
                <span class="px-3 py-1 rounded-full text-sm font-semibold bg-amber-100 text-amber-700 border border-amber-200">{{ campaign.status }}</span>
            {% endif %}
        </div>
        <div class="flex items-center text-gray-500 font-medium text-sm">
            <i class="bi bi-calendar4-week mr-2 text-primary-500"></i>
            <span>{{ campaign.start_date }} — {{ campaign.end_date }}</span>
        </div>
    </div>
    <a href="/" class="inline-flex items-center justify-center px-4 py-2 bg-white border border-gray-200 rounded-xl text-gray-600 hover:text-gray-900 hover:border-gray-300 hover:shadow-sm transition-all">
        <i class="bi bi-arrow-left mr-2"></i>Listeye Dön
    </a>
</div>

<!-- Loading State -->
<div id="loadingState" class="py-20 text-center">
    <div class="relative w-24 h-24 mx-auto mb-8">
        <div class="absolute inset-0 border-4 border-gray-100 rounded-full"></div>
        <div class="absolute inset-0 border-4 border-primary-500 rounded-full border-t-transparent animate-spin"></div>
        <i class="bi bi-cpu text-3xl text-primary-500 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></i>
    </div>
    
    <h3 class="text-2xl font-bold text-gray-900 mb-2">Analiz Sonuçları Yükleniyor...</h3>
    <p class="text-gray-500 mb-8 max-w-md mx-auto">Veriler işleniyor ve rapor dosyaları hazırlanıyor. Bu işlem veri boyutuna göre birkaç dakika sürebilir.</p>
    
    <div class="w-full max-w-md mx-auto bg-gray-100 rounded-full h-2.5 overflow-hidden">
        <div class="bg-primary-600 h-2.5 rounded-full animate-progress w-full origin-left-right"></div>
    </div>
    <style>
        @keyframes progress { 0% { width: 0%; } 50% { width: 70%; } 100% { width: 100%; } }
        .animate-progress { animation: progress 2s ease-in-out infinite; }
    </style>
</div>

<!-- Results State -->
<div id="resultsState" style="display:none;" class="animate-fade-in-up">
    
    <!-- Stats Grid (Populated by JS if stats available) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10" id="statsCards">
        <!-- JavaScript ile doldurulacak -->
    </div>

    <!-- Quality Control Report -->
    <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6 mb-10">
        <h5 class="font-bold text-gray-900 mb-6 flex items-center">
            <div class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center mr-3">
                <i class="bi bi-shield-check"></i>
            </div>
            Kalite Kontrol Raporu
        </h5>
        <div id="validationReport"></div>
    </div>

    <!-- Files Section -->
    <h5 class="font-bold text-gray-900 mb-6 flex items-center text-lg">
        <div class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center mr-3">
            <i class="bi bi-cloud-download"></i>
        </div>
        İndirilebilir Dosyalar
    </h5>
    
    <div id="filesList" class="space-y-4">
        <!-- JavaScript ile doldurulacak -->
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
const campaignId = "{{ campaign.id }}";

// Helper: Format file size
function formatSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Load Results
function loadResults() {
    fetch(`/api/campaign/${campaignId}/files`)
    .then(response => response.json())
    .then(data => {
        // Checking explicitly for completed status
        if (data.status === 'completed') {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('resultsState').style.display = 'block';
            
            renderFiles(data.files);
            
            if(data.validation) {
                renderValidation(data.validation);
            }
            
            if(data.stats) {
                renderStats(data.stats);
            }
        } else if (data.status === 'error') {
            Swal.fire({
                icon: 'error',
                title: 'Hata',
                text: 'Analiz sırasında bir hata oluştu.',
                customClass: { popup: 'rounded-2xl' }
            });
        } else {
            // Still processing
            setTimeout(loadResults, 2000);
        }
    })
    .catch(error => console.error('Error:', error));
}

function renderFiles(files) {
    const container = document.getElementById('filesList');
    container.innerHTML = '';
    
    if (!files || files.length === 0) {
        container.innerHTML = '<div class="p-4 bg-yellow-50 text-yellow-700 rounded-xl border border-yellow-100">Dosya bulunamadı.</div>';
        return;
    }

    files.forEach(file => {
        const isExcel = file.filename.endsWith('.xlsx');
        const iconClass = isExcel ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700';
        const badgeText = isExcel ? 'Excel Raporu' : 'Veri Dosyası';
        const badgeClass = isExcel ? 'bg-green-50 text-green-700 border-green-100' : 'bg-blue-50 text-blue-700 border-blue-100';

        const html = `
        <div class="bg-white border border-gray-100 rounded-xl p-5 hover:border-primary-300 hover:shadow-md transition-all duration-200 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4 ${iconClass}">
                    <i class="bi ${isExcel ? 'bi-file-earmark-excel' : 'bi-file-earmark-text'}"></i>
                </div>
                <div>
                    <h6 class="font-bold text-gray-900 mb-1">${file.filename}</h6>
                    <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500 font-medium">
                        <span class="px-2 py-0.5 rounded border ${badgeClass}">${badgeText}</span>
                        <span>${formatSize(file.size)}</span>
                        <span class="text-gray-300">•</span>
                        <span>${new Date(file.created_at * 1000).toLocaleString()}</span>
                    </div>
                </div>
            </div>
            <div class="flex w-full sm:w-auto gap-3">
                <button class="flex-1 sm:flex-none px-4 py-2 border border-gray-200 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-lg text-sm font-medium transition-colors" onclick="previewFile('${file.filename}')">
                    <i class="bi bi-eye mr-2"></i>Önizle
                </button>
                <a href="/api/campaign/${campaignId}/download/${file.filename}" class="flex-1 sm:flex-none px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm font-medium transition-colors shadow-sm shadow-primary-200 flex items-center justify-center">
                    <i class="bi bi-download mr-2"></i>İndir
                </a>
            </div>
        </div>
        `;
        container.innerHTML += html;
    });
}

function renderValidation(report) {
    const container = document.getElementById('validationReport');
    let bgClass = 'bg-green-50 border-green-100';
    let textClass = 'text-green-800';
    let icon = 'bi-check-circle-fill text-green-500';
    
    if (report.status === 'WARNING') { 
        bgClass = 'bg-amber-50 border-amber-100'; 
        textClass = 'text-amber-800'; 
        icon = 'bi-exclamation-triangle-fill text-amber-500'; 
    }
    if (report.status === 'FAILED') { 
        bgClass = 'bg-red-50 border-red-100'; 
        textClass = 'text-red-800'; 
        icon = 'bi-x-circle-fill text-red-500'; 
    }

    let html = `
    <div class="rounded-xl border ${bgClass} p-5 flex items-start gap-4">
        <i class="bi ${icon} text-xl mt-0.5"></i>
        <div>
            <h6 class="font-bold ${textClass} mb-2">Durum: ${report.status}</h6>
            <ul class="space-y-1 text-sm ${textClass} opacity-90 list-disc list-inside">
                ${report.messages.map(msg => `<li>${msg}</li>`).join('')}
            </ul>
        </div>
    </div>
    `;
    container.innerHTML = html;
}

// Dosya Önizleme Modalı
function previewFile(filename) {
    if (filename.endsWith('.xlsx')) {
        Swal.fire({
            title: 'Bilgi',
            text: 'Excel dosyaları önizlenemez, lütfen indirin.',
            icon: 'info',
            customClass: { popup: 'rounded-2xl' }
        });
        return;
    }
    
    Swal.fire({
        title: 'Yükleniyor...',
        didOpen: () => Swal.showLoading(),
        customClass: { popup: 'rounded-2xl' }
    });

    fetch(`/api/campaign/${campaignId}/preview?file=${filename}`)
        .then(r => r.json())
        .then(data => {
            if(data.error) throw new Error(data.error);
            
            // Tailwind Table
            let tableHtml = `
            <div class="overflow-x-auto max-h-[400px] border border-gray-200 rounded-lg">
                <table class="min-w-full text-left text-sm whitespace-nowrap">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            ${data.columns.map(col => `<th class="px-4 py-3 font-semibold text-gray-900 border-b border-gray-200">${col}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 bg-white">
                        ${data.rows.map(row => `
                            <tr class="hover:bg-gray-50 transition-colors">
                                ${data.columns.map(col => `<td class="px-4 py-2.5 text-gray-600 border-b border-gray-50">${row[col] === null ? '' : row[col]}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;

            Swal.fire({
                title: filename,
                html: tableHtml,
                width: '90%',
                showCloseButton: true,
                confirmButtonText: 'Kapat',
                customClass: {
                    popup: 'rounded-2xl',
                    confirmButton: 'bg-gray-800 text-white rounded-lg px-6 py-2'
                }
            });
        })
        .catch(err => Swal.fire({
            icon: 'error',
            title: 'Hata',
            text: err.message,
            customClass: { popup: 'rounded-2xl' }
        }));
}

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', loadResults);
</script>
{% endblock %}