{% extends "base.html" %}

{% block title %}Veri Düzenle - {{ campaign.name }}{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                <i class="bi bi-pencil-square text-primary-600"></i>
                Veri Düzenleme
            </h1>
            <p class="text-gray-500 mt-1 ml-8">{{ campaign.name }}</p>
        </div>
        <div>
            <a href="/campaign/{{ campaign.id }}" class="inline-flex items-center justify-center px-4 py-2 bg-white border border-gray-200 rounded-xl text-gray-600 hover:text-gray-900 hover:border-gray-300 hover:shadow-sm transition-all">
                <i class="bi bi-arrow-left mr-2"></i> Geri
            </a>
        </div>
    </div>
</div>

<div class="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-6 flex items-start gap-3 text-blue-800">
    <i class="bi bi-info-circle-fill text-xl mt-0.5 text-blue-600"></i>
    <div>
        <strong class="font-bold">Düzenleme Modu:</strong> Tablodan hücrelere çift tıklayarak düzenleyebilirsiniz. 
        Değişiklikleri kaydetmek için sağ üstteki "Kaydet" butonuna tıklayın.
    </div>
</div>

<!-- Loading -->
<div id="loadingState" class="py-20 text-center">
    <div class="w-16 h-16 border-4 border-primary-100 border-t-primary-500 rounded-full animate-spin mx-auto mb-4"></div>
    <div class="text-gray-500 font-medium">Veriler Yükleniyor...</div>
</div>

<!-- Editable Table -->
<div id="editState" style="display:none;" class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="p-4 border-b border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-4 bg-gray-50/50">
        <h5 class="font-bold text-gray-900 flex items-center gap-2">
            <i class="bi bi-table text-gray-400"></i>
            Düzenlenebilir Tablo
            <span class="px-2 py-0.5 rounded-full bg-gray-200 text-gray-600 text-xs font-medium" id="totalRows">0</span>
        </h5>
        <div>
            <button class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-sm transition-all hover:-translate-y-0.5" onclick="saveChanges()">
                <i class="bi bi-check-circle mr-2"></i> Değişiklikleri Kaydet
            </button>
        </div>
    </div>
    <div class="overflow-x-auto max-h-[600px]">
        <table class="min-w-full divide-y divide-gray-200" id="editableTable">
            <!-- Will be populated dynamically -->
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const campaignId = '{{ campaign.id }}';
let tableData = [];
let modifiedCells = new Set();

// Load data
function loadData() {
    fetch(`/api/campaign/${campaignId}/data/final_analysis`)
        .then(response => response.json())
        .then(data => {
            if (data.data) {
                tableData = data.data;
                renderTable(data);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('editState').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Hata', 'Veri yüklenirken hata oluştu: ' + error, 'error');
        });
}

// Render table
function renderTable(data) {
    const table = document.getElementById('editableTable');
    const totalRows = document.getElementById('totalRows');
    
    totalRows.textContent = `${data.data.length} kayıt`;
    
    // Header
    let html = '<thead class="bg-gray-50 sticky top-0 z-10"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 border-b border-gray-200">#</th>';
    data.columns.forEach(col => {
        html += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 border-b border-gray-200 whitespace-nowrap">${col}</th>`;
    });
    html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
    
    // Rows (first 100 for performance)
    data.data.slice(0, 100).forEach((row, rowIndex) => {
        html += `<tr class="hover:bg-gray-50 transition-colors"><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rowIndex + 1}</td>`;
        data.columns.forEach((col, colIndex) => {
            const value = row[col] !== null && row[col] !== undefined ? row[col] : '';
            const cellId = `cell_${rowIndex}_${colIndex}`;
            html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 cursor-pointer relative hover:bg-blue-50 transition-colors border-l border-transparent hover:border-blue-200" id="${cellId}" 
                         ondblclick="editCell(${rowIndex}, ${colIndex}, '${col}')">${value}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody>';
    table.innerHTML = html;
}

// Edit cell
function editCell(rowIndex, colIndex, columnName) {
    const cellId = `cell_${rowIndex}_${colIndex}`;
    const cell = document.getElementById(cellId);
    const currentValue = cell.textContent;
    
    // Create input
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'w-full px-2 py-1 text-sm border-2 border-primary-500 rounded focus:outline-none shadow-sm';
    input.value = currentValue;
    
    // Replace cell content with input
    cell.innerHTML = '';
    cell.appendChild(input);
    cell.classList.add('bg-yellow-50');
    input.focus();
    input.select();
    
    // Save on blur or enter
    function saveEdit() {
        const newValue = input.value;
        
        if (newValue !== currentValue) {
            // Update data
            tableData[rowIndex][columnName] = newValue;
            modifiedCells.add(`${rowIndex}_${colIndex}`);
            cell.classList.add('bg-green-50', 'text-green-900');
            cell.classList.remove('bg-yellow-50');
        } else {
            cell.classList.remove('bg-yellow-50');
        }
        
        cell.textContent = newValue;
    }
    
    input.addEventListener('blur', saveEdit);
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            saveEdit();
        }
    });
}

// Save changes
function saveChanges() {
    if (modifiedCells.size === 0) {
        Swal.fire('Bilgi', 'Henüz değişiklik yapmadınız.', 'info');
        return;
    }
    
    Swal.fire({
        title: 'Kaydet?',
        text: `${modifiedCells.size} hücre değiştirildi. Kaydetmek istiyor musunuz?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Evet, Kaydet',
        cancelButtonText: 'İptal',
        customClass: { popup: 'rounded-2xl' }
    }).then((result) => {
        if (result.isConfirmed) {
            // Send updated data to server
            fetch(`/api/campaign/${campaignId}/update-data`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data: tableData,
                    modified_count: modifiedCells.size
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Başarılı',
                        text: 'Değişiklikler kaydedildi!',
                        timer: 1500,
                        showConfirmButton: false,
                        customClass: { popup: 'rounded-2xl' }
                    });
                    modifiedCells.clear();
                    
                    // Remove modified highlighting
                    // Reload table to be clean or just remove classes
                    // For simplicity, reload logic is better but we can just clear classes
                    loadData(); // Reload to refresh view
                } else {
                    Swal.fire('Hata', data.error, 'error');
                }
            })
            .catch(error => {
                Swal.fire('Hata', 'Kaydetme hatası: ' + error, 'error');
            });
        }
    });
}

// Load on page load
window.addEventListener('load', loadData);
</script>
{% endblock %}