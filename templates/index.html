{% extends "base.html" %}

{% block title %}Kampanyalarım - Satış Kaynak Analizi{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8">
    <div>
        <h2 class="text-2xl font-bold text-gray-900 tracking-tight">Kampanyalarım</h2>
        <p class="text-gray-500 mt-1">Geçmiş analizlerinizi görüntüleyin ve yönetin.</p>
    </div>
    
    <!-- Filter/Search could go here -->
</div>

{% if campaigns %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for campaign in campaigns %}
    <div class="group bg-white rounded-2xl border border-gray-100 shadow-sm hover:shadow-xl hover:shadow-gray-200/50 hover:border-primary-200 transition-all duration-300 relative overflow-hidden flex flex-col">
        
        <!-- Status Strip (Left Border) -->
        <div class="absolute left-0 top-0 bottom-0 w-1 
            {% if campaign.status == 'completed' %}bg-green-500
            {% elif campaign.status == 'processing' %}bg-amber-400
            {% elif campaign.status == 'error' %}bg-red-500
            {% else %}bg-gray-300{% endif %}">
        </div>

        <div class="p-5 flex-grow">
            <!-- Header -->
            <div class="flex justify-between items-start mb-4 pl-2">
                <div>
                    <h3 class="font-bold text-gray-900 text-lg leading-tight group-hover:text-primary-600 transition-colors">{{ campaign.name }}</h3>
                    <div class="flex items-center gap-1.5 mt-1 text-xs text-gray-400 font-mono">
                        <i class="bi bi-fingerprint"></i>
                        <span>{{ campaign.id }}</span>
                    </div>
                </div>
                
                <!-- Status Badge -->
                {% if campaign.status == 'completed' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-green-50 text-green-700 border border-green-100">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 mr-1.5"></span>Tamamlandı
                    </span>
                {% elif campaign.status == 'processing' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-amber-50 text-amber-700 border border-amber-100">
                        <span class="w-1.5 h-1.5 rounded-full bg-amber-500 mr-1.5 animate-pulse"></span>İşleniyor
                    </span>
                {% elif campaign.status == 'error' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-red-50 text-red-700 border border-red-100">
                        Hata
                    </span>
                {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 border border-gray-200">
                        Bekliyor
                    </span>
                {% endif %}
            </div>

            <!-- Info Grid -->
            <div class="bg-gray-50/50 rounded-xl p-3 border border-gray-100 space-y-2">
                <div class="flex items-center text-sm text-gray-600">
                    <div class="w-8 flex justify-center text-primary-500"><i class="bi bi-calendar4-week"></i></div>
                    <span class="font-medium">{{ campaign.start_date }} <span class="text-gray-400 mx-1">→</span> {{ campaign.end_date }}</span>
                </div>
                <div class="flex items-center text-sm text-gray-500">
                    <div class="w-8 flex justify-center text-gray-400"><i class="bi bi-clock"></i></div>
                    <span>{{ campaign.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                </div>
            </div>
        </div>

        <!-- Actions Footer -->
        <div class="p-4 border-t border-gray-50 bg-gray-50/30 flex gap-2 pl-6">
            {% if campaign.status == 'completed' %}
                <a href="/campaign/{{ campaign.id }}" class="flex-1 inline-flex justify-center items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors shadow-sm shadow-green-200">
                    <i class="bi bi-file-earmark-spreadsheet mr-2"></i>Sonuçlar
                </a>
            {% elif campaign.status == 'pending' %}
                <button onclick="analyzeCampaign('{{ campaign.id }}')" class="flex-1 inline-flex justify-center items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg transition-colors shadow-sm shadow-primary-200">
                    <i class="bi bi-play-fill mr-2"></i>Başlat
                </button>
            {% elif campaign.status == 'error' %}
                <button onclick="analyzeCampaign('{{ campaign.id }}')" class="flex-1 inline-flex justify-center items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors shadow-sm shadow-red-200">
                    <i class="bi bi-arrow-clockwise mr-2"></i>Tekrar Dene
                </button>
            {% else %}
                 <button disabled class="flex-1 inline-flex justify-center items-center px-4 py-2 bg-gray-100 text-gray-400 text-sm font-medium rounded-lg cursor-not-allowed">
                    <i class="bi bi-hourglass-split mr-2 animate-spin"></i>Bekleyin
                </button>
            {% endif %}

            <button onclick="deleteCampaign('{{ campaign.id }}')" class="px-3 py-2 bg-white border border-gray-200 text-gray-400 hover:text-red-500 hover:border-red-100 hover:bg-red-50 rounded-lg transition-all" title="Kampanyayı Sil">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<!-- Empty State -->
<div class="flex flex-col items-center justify-center py-20 bg-white rounded-3xl border border-dashed border-gray-300">
    <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mb-6">
        <i class="bi bi-folder2-open text-4xl text-gray-300"></i>
    </div>
    <h3 class="text-xl font-bold text-gray-900 mb-2">Henüz kampanya yok</h3>
    <p class="text-gray-500 mb-8 max-w-sm text-center">Analiz yapmak için ilk kampanyanızı oluşturun. Müşteri listenizi yükleyin ve gerisini bize bırakın.</p>
    <a href="/campaign/new" class="inline-flex items-center px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-xl transition-all shadow-lg shadow-primary-500/30 hover:-translate-y-1">
        <i class="bi bi-plus-lg mr-2"></i>
        Yeni Kampanya Oluştur
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function analyzeCampaign(id) {
    // UI Update
    const btn = event.currentTarget;
    const originalContent = btn.innerHTML;
    
    // Disable and show spinner
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    btn.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Başlatılıyor...
    `;

    fetch(`/api/campaign/${id}/analyze`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Analiz Başlatıldı',
                text: 'Sistem arkaplanda çalışıyor, sayfa yenileniyor...',
                timer: 2000,
                showConfirmButton: false,
                customClass: {
                    popup: 'rounded-2xl',
                    confirmButton: 'bg-primary-600 rounded-lg'
                }
            }).then(() => window.location.reload());
        } else {
            throw new Error(data.error || 'Bir hata oluştu');
        }
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: 'Hata',
            text: error.message,
            customClass: {
                popup: 'rounded-2xl'
            }
        });
        btn.innerHTML = originalContent;
        btn.disabled = false;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
    });
}

function deleteCampaign(campaignId) {
    Swal.fire({
        title: 'Emin misiniz?',
        text: "Bu kampanya ve tüm analiz verileri kalıcı olarak silinecek!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#9ca3af',
        confirmButtonText: 'Evet, Sil',
        cancelButtonText: 'İptal',
        reverseButtons: true,
        customClass: {
            popup: 'rounded-2xl',
            confirmButton: 'bg-red-600 rounded-lg px-4 py-2',
            cancelButton: 'bg-gray-400 rounded-lg px-4 py-2'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/api/campaign/${campaignId}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Silindi!',
                        showConfirmButton: false,
                        timer: 1500,
                        customClass: { popup: 'rounded-2xl' }
                    }).then(() => window.location.reload());
                } else {
                    Swal.fire('Hata', 'Silinemedi', 'error');
                }
            });
        }
    });
}
</script>
{% endblock %}